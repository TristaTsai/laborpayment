<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
  // ====== PDF 中文不亂碼：每個 doc 都要註冊字體（抓字體只做一次）======
  let __fontBase64 = null;
  let __fontFetchPromise = null;

  function __arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const chunkSize = 0x8000;
    for (let i = 0; i < bytes.length; i += chunkSize) {
      const chunk = bytes.subarray(i, i + chunkSize);
      binary += String.fromCharCode.apply(null, chunk);
    }
    return btoa(binary);
  }

  async function ensureChineseFont(doc) {
    if (!__fontBase64) {
      if (!__fontFetchPromise) {
        __fontFetchPromise = (async () => {
          const res = await fetch("./fonts/NotoSansTC-Regular.ttf", { cache: "no-store" });
          if (!res.ok) throw new Error("字體載入失敗：找不到 ./fonts/NotoSansTC-Regular.ttf");
          const buf = await res.arrayBuffer();
          __fontBase64 = __arrayBufferToBase64(buf);
        })();
      }
      await __fontFetchPromise;
    }

    doc.addFileToVFS("NotoSansTC-Regular.ttf", __fontBase64);
    doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
    doc.setFont("NotoSansTC", "normal");
  }

  // ====== 綁定下載按鈕（測試版，確保一定有反應）======
  const btn = document.getElementById("downloadPdf");
  if (btn) {
    btn.addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      try {
        await ensureChineseFont(doc);
      } catch (e) {
        // 字體真的載不到，至少還能下載（但中文可能會壞）
        doc.setFont("helvetica", "normal");
      }

      doc.setFontSize(16);
      doc.text("測試中文：勞務報酬單", 20, 30);
      doc.setFontSize(12);
      doc.text("如果你看到這行中文正常，代表字體嵌入成功。", 20, 45);

      doc.save("test.pdf");
    });
  }
</script>
