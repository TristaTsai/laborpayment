<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸‰å£åœ‹éš›æ•´åˆè¡ŒéŠ·ï½œå‹å‹™å ±é…¬å–®</title>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#fff;
      --line:#e5e7eb;
      --line2:#d1d5db;
      --ink:#111827;
      --muted:#6b7280;
      --header:#334155;
      --shadow:0 6px 20px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      color:var(--ink);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:10px;
      overflow:hidden;
      box-shadow:var(--shadow);
    }

    /* ====== ä½ è¦çš„é›™è¡Œå¤§æ¨™ ====== */
    .topbar{
      background:var(--header);
      color:#fff;
      text-align:center;
      padding:14px 10px 12px;
      font-weight:900;
      letter-spacing:.6px;
      line-height:1.25;
    }
    .topbar .t1{font-size:16px; opacity:.95;}
    .topbar .t2{font-size:20px; margin-top:4px;}

    /* åªæœ‰æ—¥æœŸï¼ˆä½ èªªä¸è¦å…¬å¸åç¨±/é›»è©±ï¼‰ */
    .toprow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding:12px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }
    .topfield{display:flex;gap:8px;align-items:center;justify-content:flex-end;}
    .topfield .lab{font-size:12px;color:var(--muted);min-width:68px;text-align:right}
    .topfield input{
      width:220px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:6px;
      font-size:14px;
      background:#f9fafb;
    }

    .row{
      display:grid;
      grid-template-columns: 76px 1fr;
      border-bottom:1px solid var(--line);
      min-height:56px;
    }
    .vtag{
      writing-mode:vertical-rl;
      text-orientation:upright;
      background:#f8fafc;
      border-right:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      letter-spacing:2px;
      color:#64748b;
      padding:8px 0;
    }
    .content{padding:14px 14px;}
    .grid2{display:grid;grid-template-columns: 120px 1fr; gap:10px; align-items:center;}
    .grid2 .lab{font-size:13px;color:#374151;text-align:right;}
    .grid2 input, .grid2 select{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:6px;
      font-size:14px;
      background:#fff;
    }

    .amountRow{
      display:grid;
      grid-template-columns: 120px 1fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .amountRow .unit{color:var(--muted);font-size:14px;}
    .calc{
      font-size:13px;color:#374151;line-height:1.8;
      margin-top:8px;
    }
    .calc .sumline{
      display:flex;gap:10px;align-items:center;justify-content:flex-start;
      font-weight:900;margin-top:6px;
    }
    .checkline{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
      margin-top:6px;color:#374151;font-size:13px;
    }

    /* upload boxes */
    .uploads2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:6px;
    }
    .uploadBox{
      border:2px dashed var(--line2);
      border-radius:10px;
      height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      background:#fafafa;
      cursor:pointer;
      padding:10px;
      text-align:center;
    }
    .uploadBox .txt{
      color:#6b7280;
      font-size:13px;
      line-height:1.5;
    }
    .uploadBox .txt b{color:#374151}
    .uploadBox img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      background:#fff;
      display:none;
    }
    .uploadBox input{display:none}

    /* signature */
    .signBox{
      border:2px dashed var(--line2);
      border-radius:10px;
      padding:10px;
      background:#fafafa;
    }
    canvas{
      width:100%;
      height:180px;
      background:#fff;
      border-radius:8px;
      border:1px solid var(--line);
      touch-action:none;
      display:block;
    }
    .signTools{
      display:flex; gap:10px; justify-content:flex-end; margin-top:10px;
    }
    .miniBtn{
      border:1px solid var(--line2);
      background:#fff;
      border-radius:8px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
    }

    .footer{padding:14px;}
    .notice{
      font-size:12px;color:#4b5563;line-height:1.7;margin-bottom:12px;
    }
    .downloadBtn{
      width:100%;
      background:#1f2937;
      color:#fff;
      border:0;
      border-radius:10px;
      padding:14px 14px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    /* ===== PDF printable area (table) ===== */
    #printArea{
      width: 794px;
      background:#fff;
      color:#111;
      padding:0;
      border:1px solid #000;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    }
    .p-title{
      text-align:center;
      font-weight:900;
      font-size:18px;
      padding:10px 8px;
      border-bottom:1px solid #000;
      line-height:1.25;
    }
    .p-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:12px;
    }
    .p-table td, .p-table th{
      border:1px solid #000;
      padding:6px 6px;
      vertical-align:middle;
      word-break:break-word;
    }
    .p-center{text-align:center}
    .p-bold{font-weight:800}
    .p-box{
      border:1px dashed #777;
      height:150px;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .p-box img{max-width:100%;max-height:100%;object-fit:contain}
    .p-sign{height:150px}
    .p-footnote{
      font-size:11px;
      padding:10px;
      border-top:1px solid #000;
      line-height:1.6;
    }

   @media (max-width: 520px){
  .row{
    grid-template-columns: 64px 1fr;
  }

  /* ğŸ”‘ æ ¸å¿ƒï¼šæ‰‹æ©Ÿç‰ˆæ¬„ä½æ”¹æˆä¸Šä¸‹æ’åˆ— */
  .grid2{
    grid-template-columns: 1fr;
  }

  .grid2 .lab{
    text-align: left;
    margin-bottom: 4px;
    font-weight: 700;
  }

  .topfield{
    justify-content: flex-start;
  }

  .topfield input{
    width: 100%;
  }
}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="t1">ä¸‰å£åœ‹éš›æ•´åˆè¡ŒéŠ·</div>
        <div class="t2">å‹å‹™å ±é…¬å–®</div>
      </div>

      <!-- åªä¿ç•™æ—¥æœŸ -->
      <div class="toprow">
        <div class="topfield">
          <div class="lab">è£½è¡¨æ—¥æœŸ</div>
          <input id="formDate" type="date" />
        </div>
      </div>

      <!-- åŸºæœ¬è³‡æ–™ -->
      <div class="row">
        <div class="vtag">é ˜æ¬¾äººåŸºæœ¬è³‡æ–™</div>
        <div class="content">
          <div class="grid2"><div class="lab">å§“å</div><input id="payeeName"></div>
          <div class="grid2"><div class="lab">èº«åˆ†è­‰å­—è™Ÿ</div><input id="idNumber"></div>
          <div class="grid2"><div class="lab">è¯çµ¡æ–¹å¼</div><input id="contact"></div>
          <div class="grid2"><div class="lab">æˆ¶ç±åœ°å€</div><input id="address"></div>
          <div class="grid2"><div class="lab">åœ‹ç±</div><input id="nationality" value="è‡ºç£"></div>
        </div>
      </div>

      <!-- å°ˆæ¡ˆè³‡è¨Š -->
      <div class="row">
        <div class="vtag">å°ˆæ¡ˆè³‡è¨Š</div>
        <div class="content">
          <div class="grid2"><div class="lab">å°ˆæ¡ˆåç¨±</div><input id="projectName"></div>
          <div class="grid2"><div class="lab">å‹å‹™å…§å®¹</div><input id="serviceContent"></div>
          <div class="grid2">
            <div class="lab">æ‰€å¾—é¡åˆ¥</div>
            <select id="incomeCategory">
              <option value="9A åŸ·è¡Œæ¥­å‹™æ‰€å¾—">9A åŸ·è¡Œæ¥­å‹™æ‰€å¾—</option>
              <option value="9B ç¨¿è²»">9B ç¨¿è²»</option>
              <option value="50 è–ªè³‡æ‰€å¾—">50 è–ªè³‡æ‰€å¾—</option>
            </select>
          </div>
        </div>
      </div>

      <!-- é‡‘é¡ -->
      <div class="row">
        <div class="vtag">é‡‘é¡</div>
        <div class="content">
          <div class="amountRow">
            <div class="lab" style="text-align:right;font-weight:700;color:#374151;">æ‡‰ä»˜ç¸½é¡ï¼š</div>
            <input id="grossAmount" inputmode="numeric" />
            <div class="unit">å…ƒ</div>
          </div>

          <div class="calc">
            <div>ï¼ ä»£æ‰£ç¹³æ‰€å¾—ç¨…ï¼š<span class="p-muted">ï¼ˆé” 20,010 å…ƒï¼Œä»£æ‰£ç¹³ 10%ï¼‰</span>ï¼š<span id="taxAmt">0</span> å…ƒ</div>
            <div>ï¼ äºŒä»£å¥ä¿è£œå……ä¿è²»ï¼š<span class="p-muted">ï¼ˆé” 20,000 å…ƒï¼Œä»£æ‰£ç¹³ 2.11%ï¼‰</span>ï¼š<span id="nhiAmt">0</span> å…ƒ</div>
            <div class="sumline">
              <div style="width:18px;text-align:center;">ï¼</div>
              <div>æ‡‰ä»˜æ·¨é¡ï¼š<span id="netAmt">0</span> å…ƒ</div>
            </div>
          </div>
        </div>
      </div>

      <!-- èº«åˆ†è­‰ä»¶ï¼ˆä½ è¦æ­£é¢/åé¢ï¼‰ -->
      <div class="row">
        <div class="vtag">é ˜æ¬¾äººèº«åˆ†è­‰ä»¶</div>
        <div class="content">
          <div class="uploads2">
            <label class="uploadBox">
              <input id="idFront" type="file" accept="image/*">
              <div class="txt"><b>èº«åˆ†è­‰æ­£é¢</b><br>é»æ“Šä¸Šå‚³åœ–ç‰‡</div>
              <img id="frontPreview" alt="" />
            </label>
            <label class="uploadBox">
              <input id="idBack" type="file" accept="image/*">
              <div class="txt"><b>èº«åˆ†è­‰åé¢</b><br>é»æ“Šä¸Šå‚³åœ–ç‰‡</div>
              <img id="backPreview" alt="" />
            </label>
          </div>
        </div>
      </div>

      <!-- ä»˜æ¬¾æ–¹å¼ï¼ˆå«å­˜æ‘ºå°é¢æç¤ºï¼‰ -->
      <div class="row">
        <div class="vtag">ä»˜æ¬¾æ–¹å¼</div>
        <div class="content">
          <div class="grid2"><div class="lab">éŠ€è¡Œ</div><input id="bankName" placeholder="è«‹è¼¸å…¥éŠ€è¡Œåç¨±"></div>
          <div class="grid2"><div class="lab">åˆ†è¡Œ</div><input id="bankBranch" placeholder="è«‹è¼¸å…¥åˆ†è¡Œåç¨±"></div>
          <div class="grid2"><div class="lab">æˆ¶å</div><input id="accountName" placeholder="è«‹è¼¸å…¥æˆ¶å"></div>
          <div class="grid2"><div class="lab">å¸³è™Ÿ</div><input id="accountNo" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"></div>

          <div style="margin-top:10px;">
            <label class="uploadBox" style="height:170px;">
              <input id="bankbook" type="file" accept="image/*">
              <div class="txt"><b>å­˜æ‘ºå°é¢</b><br>é»æ“Šä¸Šå‚³å­˜æ‘ºå°é¢å½±æœ¬</div>
              <img id="bankPreview" alt="" />
            </label>
          </div>
        </div>
      </div>

      <!-- ç°½å -->
      <div class="row" style="border-bottom:none;">
        <div class="vtag">ç°½å</div>
        <div class="content">
          <div class="signBox">
            <div style="text-align:center;color:#6b7280;font-weight:900;margin-bottom:10px;">é ˜æ¬¾äººç°½å</div>
            <canvas id="signCanvas"></canvas>
            <div class="signTools">
              <button class="miniBtn" id="clearSign" type="button">æ¸…é™¤</button>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="notice">
          èªªæ˜ï¼š<br>
          1. æœ¬è¡¨å–®æ‰€æœ‰æ¬„ä½è‹¥æœªå®Œæ•´å¡«å¯«ï¼Œå°‡æœƒå½±éŸ¿æ‚¨çš„è«‹æ¬¾æµç¨‹ï¼Œæ•¬è«‹é…åˆã€‚<br>
          2. å¡«å¯«å®Œç•¢å¾Œï¼Œè«‹ä¸‹è¼‰ PDF æª”æ¡ˆä¸¦å‚³é€çµ¦ä¼åŠƒäººå“¡ã€‚<br>
          3. æœ¬å·¥å…·ä¸æœƒç´€éŒ„åŠæœé›†ä»»ä½•è³‡æ–™èˆ‡åœ–ç‰‡ï¼Œé‡æ–°æ•´ç†é é¢å¾Œï¼Œæ‰€æœ‰å·²å¡«è³‡æ–™å°‡æœƒè‡ªå‹•æ¶ˆå¤±ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚
        </div>
        <button id="downloadBtn" class="downloadBtn" type="button">ä¸‹è¼‰å‹å‹™å ±é…¬å–® â¬‡ï¸</button>
      </div>
    </div>
  </div>

  <!-- Hidden printable area for PDF -->
  <div style="position:absolute; left:-99999px; top:-99999px;">
    <div id="printArea">
      <div class="p-title">ä¸‰å£åœ‹éš›æ•´åˆè¡ŒéŠ·<br>å‹å‹™å ±é…¬å–®</div>
      <table class="p-table">
        <tr>
          <td colspan="5"><span class="p-bold">è£½è¡¨æ—¥æœŸï¼š</span><span id="p_formDate"></span></td>
          <td colspan="2"><span class="p-bold">å°ˆæ¡ˆåç¨±ï¼š</span><span id="p_projectName"></span></td>
        </tr>

        <tr>
          <td rowspan="4" class="p-center p-bold" style="width:70px;">é ˜<br>æ¬¾<br>äºº<br>åŸº<br>æœ¬<br>è³‡<br>æ–™</td>
          <td class="p-center p-bold" style="width:80px;">å§“å</td>
          <td colspan="2" id="p_payeeName"></td>
          <td class="p-center p-bold" style="width:80px;">åœ‹ç±</td>
          <td colspan="2" id="p_nationality"></td>
        </tr>
        <tr>
          <td class="p-center p-bold">èº«åˆ†è­‰å­—è™Ÿ</td>
          <td colspan="2" id="p_idNumber"></td>
          <td class="p-center p-bold">è¯çµ¡æ–¹å¼</td>
          <td colspan="2" id="p_contact"></td>
        </tr>
        <tr>
          <td class="p-center p-bold">æˆ¶ç±åœ°å€</td>
          <td colspan="5" id="p_address"></td>
        </tr>
        <tr>
          <td class="p-center p-bold">å‹å‹™å…§å®¹</td>
          <td colspan="2" id="p_serviceContent"></td>
          <td class="p-center p-bold">æ‰€å¾—é¡åˆ¥</td>
          <td colspan="2" id="p_incomeCategory"></td>
        </tr>

        <tr>
          <td rowspan="2" class="p-center p-bold">é‡‘<br>é¡</td>
          <td class="p-center p-bold" colspan="2">æ‡‰ä»˜ç¸½é¡</td>
          <td colspan="4"><span id="p_grossAmount"></span> å…ƒ</td>
        </tr>
        <tr>
          <td colspan="6">
            ï¼ ä»£æ‰£ç¹³æ‰€å¾—ç¨…ï¼š <span id="p_taxAmt"></span> å…ƒ<br>
            ï¼ äºŒä»£å¥ä¿è£œå……ä¿è²»ï¼š <span id="p_nhiAmt"></span> å…ƒ
            <div style="margin-top:6px;font-weight:900;">ï¼ æ‡‰ä»˜æ·¨é¡ï¼š <span id="p_netAmt"></span> å…ƒ</div>
          </td>
        </tr>

        <tr>
          <td rowspan="2" class="p-center p-bold">èº«<br>åˆ†<br>è­‰<br>ä»¶</td>
          <td colspan="3" class="p-center p-bold">èº«åˆ†è­‰æ­£é¢</td>
          <td colspan="3" class="p-center p-bold">èº«åˆ†è­‰åé¢</td>
        </tr>
        <tr>
          <td colspan="3"><div class="p-box"><img id="p_frontImg" alt=""></div></td>
          <td colspan="3"><div class="p-box"><img id="p_backImg" alt=""></div></td>
        </tr>

        <tr>
          <td class="p-center p-bold">ä»˜<br>æ¬¾<br>è³‡<br>è¨Š</td>
          <td colspan="6">
            éŠ€è¡Œï¼š<span id="p_bankName"></span>
           ã€€åˆ†è¡Œï¼š<span id="p_bankBranch"></span>
           ã€€å¸³è™Ÿï¼š<span id="p_accountNo"></span>
           ã€€æˆ¶åï¼š<span id="p_accountName"></span>
          </td>
        </tr>

        <tr>
          <td class="p-center p-bold" colspan="4">å­˜æ‘ºå°é¢</td>
          <td class="p-center p-bold" colspan="3">é ˜æ¬¾äººç°½å</td>
        </tr>
        <tr>
          <td colspan="4"><div class="p-box"><img id="p_bankImg" alt=""></div></td>
          <td colspan="3"><div class="p-box p-sign"><img id="p_signImg" alt=""></div></td>
        </tr>
      </table>

      <div class="p-footnote">
        èªªæ˜ï¼š1. æœ¬è¡¨å–®æ‰€æœ‰æ¬„ä½è‹¥æœªå®Œæ•´å¡«å¯«ï¼Œå°‡æœƒå½±éŸ¿æ‚¨çš„è«‹æ¬¾æµç¨‹ï¼Œæ•¬è«‹é…åˆã€‚<br>
        2. å¡«å¯«å®Œç•¢å¾Œï¼Œè«‹ä¸‹è¼‰ PDF æª”æ¡ˆä¸¦å‚³é€çµ¦ä¼åŠƒäººå“¡ã€‚<br>
        3. æœ¬å·¥å…·ä¸æœƒç´€éŒ„åŠæœé›†ä»»ä½•è³‡æ–™èˆ‡åœ–ç‰‡ï¼Œé‡æ–°æ•´ç†é é¢å¾Œï¼Œæ‰€æœ‰å·²å¡«è³‡æ–™å°‡æœƒè‡ªå‹•æ¶ˆå¤±ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ===== date default today (local) =====
    (function initDate(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('formDate').value = `${yyyy}-${mm}-${dd}`;
    })();

    // ===== helpers =====
    function toNumber(s){
      const n = Number(String(s||"").replace(/[^\d.]/g,''));
      return Number.isFinite(n) ? n : 0;
    }
    function fmt0(n){ return String(Math.round(n)).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function setText(id, v){ document.getElementById(id).textContent = v || ""; }

    // ===== image preview + store =====
    const imgState = { front:"", back:"", bank:"", sign:"" };

    function bindImage(inputId, imgId){
      const input = document.getElementById(inputId);
      const img = document.getElementById(imgId);
      input.addEventListener('change', e=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          img.src = reader.result;
          img.style.display = "block";
          if(inputId==="idFront") imgState.front = reader.result;
          if(inputId==="idBack") imgState.back = reader.result;
          if(inputId==="bankbook") imgState.bank = reader.result;
          syncToPrint();
        };
        reader.readAsDataURL(f);
      });
    }
    bindImage("idFront","frontPreview");
    bindImage("idBack","backPreview");
    bindImage("bankbook","bankPreview");

    // ===== smooth signature (pointer events) =====
    const canvas = document.getElementById("signCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      ctx.setTransform(ratio,0,0,ratio,0,0);
      ctx.lineWidth = 2.4;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#111";
    }
    window.addEventListener("resize", resizeCanvas);
    setTimeout(resizeCanvas, 0);

    let drawing = false;
    let last = null;

    function getPoint(ev){
      const rect = canvas.getBoundingClientRect();
      const e = ev.touches ? ev.touches[0] : ev;
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
    function drawLine(a,b){
      const mx = (a.x + b.x)/2;
      const my = (a.y + b.y)/2;
      ctx.quadraticCurveTo(a.x, a.y, mx, my);
      ctx.stroke();
    }
    function start(ev){
      ev.preventDefault();
      drawing = true;
      last = getPoint(ev);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
    }
    function move(ev){
      if(!drawing) return;
      ev.preventDefault();
      const p = getPoint(ev);
      drawLine(last, p);
      last = p;
    }
    function end(){
      if(!drawing) return;
      drawing = false;
      last = null;
      imgState.sign = canvas.toDataURL("image/png");
      syncToPrint();
    }

    canvas.addEventListener("pointerdown", start);
    canvas.addEventListener("pointermove", move);
    canvas.addEventListener("pointerup", end);
    canvas.addEventListener("pointercancel", end);
    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    canvas.addEventListener("touchend", end);

    document.getElementById("clearSign").addEventListener("click", ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      imgState.sign = "";
      syncToPrint();
    });

    // ===== calc =====
    const grossInput = document.getElementById("grossAmount");
    const taxEl = document.getElementById("taxAmt");
    const nhiEl = document.getElementById("nhiAmt");
    const netEl = document.getElementById("netAmt");

    const TAX_THRESHOLD = 20010;
    const TAX_RATE = 0.10;
    const NHI_THRESHOLD = 20000;
    const NHI_RATE = 0.0211;

    function recompute(){
      const gross = toNumber(grossInput.value);
      const income = document.getElementById("incomeCategory").value;

      let tax = 0;
      let taxText = "0";

      // 50 è–ªè³‡ â†’ é¡¯ç¤º N/Aï¼ˆä¸è¨ˆç®—æ‰€å¾—ç¨…ï¼‰
      if (income === "50 è–ªè³‡æ‰€å¾—") {
        taxText = "N/A";
        tax = 0;
      } else {
        tax = gross >= TAX_THRESHOLD ? Math.round(gross * TAX_RATE) : 0;
        taxText = fmt0(tax);
      }

      const nhi = gross >= NHI_THRESHOLD ? Math.round(gross * NHI_RATE) : 0;
      const net = Math.max(0, gross - (taxText === "N/A" ? 0 : tax) - nhi);

      taxEl.textContent = taxText;
      nhiEl.textContent = fmt0(nhi);
      netEl.textContent = fmt0(net);

      return { gross, tax, taxText, nhi, net };
    }

    grossInput.addEventListener("input", ()=>{ recompute(); syncToPrint(); });
    document.getElementById("incomeCategory").addEventListener("change", ()=>{ recompute(); syncToPrint(); });

    // ===== sync form -> print =====
    const ids = [
      "formDate",
      "payeeName","idNumber","contact","address","nationality",
      "projectName","serviceContent","incomeCategory",
      "bankName","bankBranch","accountName","accountNo"
    ];
    ids.forEach(id=>{
      document.getElementById(id).addEventListener("input", syncToPrint);
      document.getElementById(id).addEventListener("change", syncToPrint);
    });

    function syncToPrint(){
      const calc = recompute();

      setText("p_formDate", document.getElementById("formDate").value);
      setText("p_projectName", document.getElementById("projectName").value);

      setText("p_payeeName", document.getElementById("payeeName").value);
      setText("p_idNumber", document.getElementById("idNumber").value);
      setText("p_contact", document.getElementById("contact").value);
      setText("p_address", document.getElementById("address").value);
      setText("p_nationality", document.getElementById("nationality").value);

      setText("p_serviceContent", document.getElementById("serviceContent").value);
      setText("p_incomeCategory", document.getElementById("incomeCategory").value);

      setText("p_grossAmount", fmt0(calc.gross));
      setText("p_taxAmt", calc.taxText);
      setText("p_nhiAmt", fmt0(calc.nhi));
      setText("p_netAmt", fmt0(calc.net));

      setText("p_bankName", document.getElementById("bankName").value);
      setText("p_bankBranch", document.getElementById("bankBranch").value);
      setText("p_accountNo", document.getElementById("accountNo").value);
      setText("p_accountName", document.getElementById("accountName").value);

      document.getElementById("p_frontImg").src = imgState.front || "";
      document.getElementById("p_backImg").src  = imgState.back  || "";
      document.getElementById("p_bankImg").src  = imgState.bank  || "";
      document.getElementById("p_signImg").src  = imgState.sign  || "";
    }

    recompute();
    syncToPrint();

    // ===== download PDF from printArea =====
    document.getElementById("downloadBtn").addEventListener("click", async ()=>{
      const node = document.getElementById("printArea");

      const canvas = await html2canvas(node, {
        scale: 2,
        backgroundColor: "#ffffff",
        useCORS: true
      });

      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");

      const pageW = 210;
      const pageH = 297;
      const imgW = pageW;
      const imgH = canvas.height * imgW / canvas.width;

      pdf.addImage(imgData, "PNG", 0, 0, imgW, Math.min(imgH, pageH));

      const safe = (s)=> (s||"").replace(/[\\/:*?"<>|]/g,"_");
      const fnProject = (document.getElementById("projectName").value || "å‹å‹™å ±é…¬å–®").trim();
      const fnName = (document.getElementById("payeeName").value || "").trim();
      pdf.save(`${safe(fnProject)}_${safe(fnName)}_å‹å‹™å ±é…¬å–®.pdf`);
    });
  </script>
</body>
</html>
