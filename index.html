<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>勞報單產生器</title>
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; padding: 16px; max-width: 980px; margin: 0 auto; }
    h1 { margin: 8px 0 12px; }
    h2 { margin: 18px 0 10px; font-size: 18px; }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 860px){
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }
    label { display:block; margin: 6px 0 6px; font-weight: 650; }
    input, select { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    .muted { color:#666; font-size: 13px; line-height: 1.5; }
    button { padding: 10px 14px; font-size: 16px; }
    .totals { font-size: 15px; line-height: 1.9; }
    .totals b { font-size: 16px; }
    .preview { width: 100%; max-height: 240px; object-fit: contain; border: 1px dashed #ccc; border-radius: 10px; background:#fafafa; }
    canvas { touch-action: none; }
    .sigbox { border: 1px dashed #aaa; border-radius: 10px; width: 100%; height: 180px; background: #fff; }
    .warn { color:#b45309; font-size: 13px; }
    code { background:#f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>三壐國際整合行銷 勞務報酬單</h1>

  <div class="card">
    <div class="row">
      <div><b>製表日期：</b></div>
      <input id="formDate" type="date" style="max-width: 220px;">
      <div class="muted">（可留空，預設今天）</div>
    </div>
  </div>

  <h2>領款人基本資料</h2>
  <div class="card grid grid-2">
    <div>
      <label>姓名</label>
      <input id="payeeName" placeholder="請輸入姓名">
    </div>
    <div>
      <label>身分證字號（外國籍請填居留證號）</label>
      <input id="payeeId" placeholder="">
    </div>
    <div>
      <label>聯絡方式</label>
      <input id="payeeContact" placeholder="電話或Email">
    </div>
    <div>
      <label>國籍</label>
      <input id="payeeNationality" placeholder="">
    </div>
    <div style="grid-column: 1 / -1;">
      <label>戶籍地址</label>
      <input id="payeeAddress" placeholder="">
    </div>
  </div>

  <h2>專案資訊</h2>
  <div class="card grid grid-2">
    <div>
      <label>專案名稱</label>
      <input id="projectName" placeholder="">
    </div>
    <div>
      <label>勞務內容</label>
      <input id="serviceContent" placeholder="">
    </div>
    <div>
      <label>公司名稱</label>
      <input id="companyName" placeholder="">
    </div>
    <div>
      <label>公司聯絡方式</label>
      <input id="companyContact" placeholder="">
    </div>

    <div>
      <label>所得類別</label>
      <select id="incomeCategory">
        <option value="">請選擇</option>
        <option value="9A">9A 執行業務所得</option>
        <option value="9B">9B 稿費所得</option>
        <option value="50">50 薪資所得</option>
        <option value="92">92 其他所得</option>
      </select>
    </div>

    <div>
      <label>金額</label>
      <input id="amount" inputmode="numeric" placeholder="例：6000">
    </div>

    <div style="grid-column: 1 / -1;">
      <div class="row" style="margin-top: 6px;">
        <input id="unionInsured" type="checkbox" style="width:auto;">
        <label for="unionInsured" style="margin:0;">領款人有投保工會（此範本視為免扣二代健保）</label>
      </div>

      <div class="totals" id="totals"></div>
      <div class="muted">*門檻採用常見設定：代扣稅 ≥ 20,010 扣 10%；二代健保 ≥ 20,000 扣 2.11%（勾選工會則免扣）。可自行改規則。</div>
    </div>
  </div>

  <h2>領款人身分證件</h2>
  <div class="card grid grid-2">
    <div>
      <label>正面</label>
      <input id="idFront" type="file" accept="image/*">
      <img id="idFrontPreview" class="preview" alt="身分證正面預覽">
    </div>
    <div>
      <label>反面</label>
      <input id="idBack" type="file" accept="image/*">
      <img id="idBackPreview" class="preview" alt="身分證反面預覽">
    </div>
  </div>

  <h2>付款方式</h2>
  <div class="card grid grid-2">
    <div>
      <label>銀行</label>
      <input id="bankName" placeholder="例：">
    </div>
    <div>
      <label>分行</label>
      <input id="bankBranch" placeholder="例：">
    </div>
    <div>
      <label>戶名</label>
      <input id="bankAccountName" placeholder="">
    </div>
    <div>
      <label>帳號</label>
      <input id="bankAccountNumber" placeholder="">
    </div>
    <div style="grid-column: 1 / -1;">
      <label>帳戶影本</label>
      <input id="bankCopy" type="file" accept="image/*">
      <img id="bankCopyPreview" class="preview" alt="帳戶影本預覽">
    </div>
  </div>

  <h2>簽名</h2>
  <div class="card">
    <label>領款人簽名（手寫）</label>
    <canvas id="sigCanvas" class="sigbox"></canvas>
    <div class="row" style="margin-top: 10px;">
      <button id="sigClear" type="button">清除</button>
      <span class="muted">用手指/滑鼠簽名；下載 PDF 會把簽名帶進去。</span>
    </div>
  </div>

  <div class="card" style="margin-top: 16px;">
    <div class="muted">
      聲明：<br>
      1. 本表單所有欄位若未完整填寫，將會影響您的請款流程，敬請配合。<br>
      2. 填寫完畢後，請下載將PDF檔案並傳送給本公司企劃人員。<br>
      3. 本工具不會紀錄及搜集任何資料與圖片，重新整理網頁後，所有已填資料將會自動消失，請安心使用。
    </div>
    <div class="row" style="margin-top: 12px;">
      <button id="downloadPdf" type="button">下載勞務報酬單</button>
      <span class="warn" id="fontWarn"></span>
    </div>

    <div class="muted" style="margin-top: 10px;">
      </code>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
   <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
  // ====== PDF 中文不亂碼：每個 doc 都要註冊字體（抓字體只做一次）======
  let __fontBase64 = null;
  let __fontFetchPromise = null;

  function __arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const chunkSize = 0x8000;
    for (let i = 0; i < bytes.length; i += chunkSize) {
      const chunk = bytes.subarray(i, i + chunkSize);
      binary += String.fromCharCode.apply(null, chunk);
    }
    return btoa(binary);
  }

  async function ensureChineseFont(doc) {
    if (!__fontBase64) {
      if (!__fontFetchPromise) {
        __fontFetchPromise = (async () => {
          const res = await fetch("./fonts/NotoSansTC-Regular.ttf", { cache: "no-store" });
          if (!res.ok) throw new Error("字體載入失敗：找不到 ./fonts/NotoSansTC-Regular.ttf");
          const buf = await res.arrayBuffer();
          __fontBase64 = __arrayBufferToBase64(buf);
        })();
      }
      await __fontFetchPromise;
    }

    doc.addFileToVFS("NotoSansTC-Regular.ttf", __fontBase64);
    doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
    doc.setFont("NotoSansTC", "normal");
  }

  // ====== 綁定下載按鈕（測試版，確保一定有反應）======
  const btn = document.getElementById("downloadPdf");
  if (btn) {
    btn.addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      try {
        await ensureChineseFont(doc);
      } catch (e) {
        // 字體真的載不到，至少還能下載（但中文可能會壞）
        doc.setFont("helvetica", "normal");
      }

      doc.setFontSize(16);
      doc.text("測試中文：勞務報酬單", 20, 30);
      doc.setFontSize(12);
      doc.text("如果你看到這行中文正常，代表字體嵌入成功。", 20, 45);

      doc.save("test.pdf");
    });
  }
</script>
  </script>
</body>
</html>
